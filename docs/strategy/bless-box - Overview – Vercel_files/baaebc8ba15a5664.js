;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="d74356a4-c89d-bf46-ff81-d885338c97a9")}catch(e){}}();
(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,5598924,5442212,e=>{"use strict";var t=e.i(847684),l=e.i(9338892),a=e.i(7185353),i=e.i(5255926),s=e.i(6881349),n=e.i(6352514),r=e.i(4759942),o=e.i(1991452),c=e.i(8238875),d=e.i(9031150),u=e.i(935882);let m=()=>{let e=(0,c.useSearchParams)();return{isReady:(0,o.useRouter)().isReady,filterBranch:e?.get("filterBranch")||void 0}};e.s(["useProjectFilteredBranch",0,function(){let{project:e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=m(),[l,i]=(0,a.useState)(t.filterBranch||null);(0,a.useEffect)(()=>{i(t.filterBranch||null)},[t.isReady,t.filterBranch]);let s=(0,o.useRouter)(),n=(0,a.useCallback)(e=>{(0,d.awaitPaint)().then(()=>{i(e),function(e,t){let{teamSlug:l,project:a,slug:i,...s}=e.query;t?s.filterBranch=t:delete s.filterBranch,e.replace({pathname:window.location.pathname,query:s},void 0,{shallow:!0,scroll:!1})}(s,e)})},[s]),r=l?{ref:l}:void 0,c=(0,a.useCallback)(()=>{l&&(i(null),n(null))},[l,n]),h=!e||!t.isReady,x=null!==l,[p,y]=(0,a.useState)(x);return(0,u.default)(()=>{y(x)},[y,h,x]),{showBranchFilterBar:p,filteredBranch:l,setFilteredBranch:n,clearBranch:c,gitSource:r}},"useRouterFilteredBranch",0,m],5442212);var h=e.i(1947138),x=e.i(7401972);let p=(0,a.memo)(e=>{let{loading:i,skeleton:o,onSelect:c,project:d,value:p,includeProductionBranch:f,placeholder:j,skeletonStyle:g,comboboxSize:b,clearable:v}=e,[k,S]=(0,a.useState)(!1),[C,A]=(0,a.useState)(!1),[R,N,{currentValue:D,setValueImmediate:w}]=(0,h.useDebounceState)(p||"",300);(0,a.useEffect)(()=>{p&&w(p)},[w,p]);let[,{branches:P,isValidating:T,fetchedQuery:I}]=(0,x.useProjectDeployedBranches)({project:d,includeProductionBranch:f,query:R},{revalidateOnFocus:!1,revalidateIfStale:!1,revalidateOnReconnect:!1}),M=(I||"")!==R,E=!!C&&!!k&&!!D&&M,{filterBranch:L}=m();(0,a.useEffect)(()=>{L&&w(L)},[w,L]),(0,a.useEffect)(()=>{w(p||"")},[w,p]),(0,a.useEffect)(()=>{k||P&&!T&&S(!0)},[k,P,T]);let[O,B]=(0,a.useState)([]);(0,a.useEffect)(()=>{T||void 0===P||(0!==$.current.query.indexOf(D)&&($.current={values:[],query:D}),B(P||[]))},[JSON.stringify(P),I]);let $=(0,a.useRef)({values:[],query:""}),_=T||D.length>=R.length&&D.length>=1?$.current.values:[],F=[...new Set([..._,...E?O:P||[]])],H=(0,a.useRef)(null);return((0,u.default)(()=>{D&&H.current?.setValue(D)},[D]),(0,u.default)(()=>{p||H.current?.clear()},[p]),o&&!k)?(0,t.jsx)(y,{skeletonStyle:g}):(0,t.jsxs)(s.Combobox,{clearable:v,filter:function(e,t){let a=""===t?e:(0,l.matchSorter)(e,t,{keys:["value","label"]}),i=[];for(let e of _)a.find(t=>t.value===e)&&i.push(e);let s=[...new Set([...i,...a.map(e=>e.value)])],n=s.map(e=>{let t=a.find(t=>t.value===e);if(!t)throw Error("impossible state");return t});return $.current={values:s,query:D},n},loading:E||i,onChange:e=>{e===L?setTimeout(()=>{c?.(null),H.current?.clear(),w("")}):(r.analytics.track(n.AnalyticsEvent.DEPLOYMENT_OVERVIEW_FILTERS_BRANCH,{value:e}),w(e||""),c?.(e))},onChangeOpen:e=>{A(e)},placeholder:j||"All Branches…",ref:H,size:b,children:[(0,t.jsx)(s.Combobox.Input,{loading:E||i,onChange:e=>{""===e.target.value?w(""):N(e.target.value)}}),(0,t.jsx)(s.Combobox.List,{children:F.map((e,l)=>(0,t.jsx)(s.Combobox.Option,{value:e,children:e},D?e:`${e}${l}`))})]})});function y(e){let{skeletonStyle:l}=e;return(0,t.jsx)(i.Skeleton,{style:l||{height:40},width:"100%"})}e.s(["BranchSearchCombobox",0,function(e){let{skeletonStyle:l}=e;return(0,t.jsx)(a.Suspense,{fallback:(0,t.jsx)(y,{skeletonStyle:l}),children:(0,t.jsx)(p,{...e})})}],5598924)},2645806,e=>{"use strict";var t=e.i(847684),l=e.i(7185353),a=e.i(2111701),i=e.i(6891161),s=e.i(455575),n=e.i(277234),r=e.i(4244280),o=e.i(4470704);let c=l.default.memo(e=>{let{active:c,onClose:d,deployment:u,teamId:m}=e,[h,x]=(0,l.useState)(!1),p=(0,s.useToasts)(),y=(0,l.useCallback)(async()=>{if(!u)return;x(!0);let e=m?"?teamId="+m:"",t=await (0,n.fetchAPI)(`${(0,r.API_DEPLOYMENTS)("v12")}/${u.id}/cancel`+e,{throwOnHTTPError:!1,method:"PATCH"});t.error&&p.error(`Could not cancel the deployment, it's ${u.readyState}`),"CANCELED"===t.readyState&&(p.success("The deployment has been successfully canceled."),(0,a.mutate)((0,o.getUrl)(u.id),{...u,readyState:t.readyState,status:t.readyState,canceledAt:t.canceledAt,host:u.url,isPrivate:!u.public})),x(!1),d()},[u,m,p,d]);return(0,t.jsxs)(i.Modal.Modal,{active:c,onClickOutside:d,width:"500px",children:[(0,t.jsxs)(i.Modal.Body,{children:[(0,t.jsx)(i.Modal.Header,{children:(0,t.jsx)(i.Modal.Title,{children:"Cancel Deployment"})}),(0,t.jsx)("p",{className:"text-copy-16",children:"Canceling this deployment will immediately stop the build, with no way to resume."}),(0,t.jsx)("p",{className:"text-copy-16",style:{margin:0},children:"Are you sure you want to continue?"})]}),(0,t.jsxs)(i.Modal.Actions,{children:[(0,t.jsx)(i.Modal.Action,{loading:!1,onClick:d,type:"secondary",children:"Close"}),(0,t.jsx)(i.Modal.Action,{disabled:h,loading:h,onClick:y,children:"Cancel deployment"})]})]})});e.s(["default",0,c])},5229375,e=>{"use strict";var t=e.i(7185353),l=e.i(7909933),a=e.i(3924999),i=e.i(818351),s=e.i(8042625),n=e.i(277234),r=e.i(4244280),o=e.i(5338940);function c(e,t){let l=(0,s.encode)(e,!1),a=t?`&${t}`:"";return l?`?${l}${a}`:`?${a}`}e.s(["useAliases",0,function(e,t){return(0,l.default)(()=>{if(!e)return null;let{team:t,id:l,teamId:a}=e;return`${(0,r.API_DEPLOYMENTS)("v2")}/${l}/aliases${(0,s.encode)({teamId:a??(t?t.id:null)})}`},e=>(0,n.fetchAPI)(e,{throwOnHTTPError:!0}),t)},"useAliasesInfinite",0,function(e,l){let{limit:i=20,domains:s,rollbackDeploymentId:d}=e,{isReady:u,team:m}=(0,o.useTeam)(),h=(0,a.default)((e,t)=>{if(!u)return null;let l=`${r.API_ALIASES}`,a=s?.map(e=>`domain=${encodeURIComponent(e)}`).join("&")||null;if(!e)return`${l}${c({limit:i+1,teamId:m?.id,rollbackDeploymentId:d},a)}`;let n=t?.aliases&&t.aliases.length>i?t.aliases[i-1].createdAt:null;return n?`${l}${c({limit:i+1,teamId:m?.id,until:n},a)}`:null},e=>(0,n.fetchAPI)(e,{throwOnHTTPError:!0}),l),x=(0,t.useMemo)(()=>h.data?[].concat(...h.data.filter(Boolean).map(e=>e.aliases.slice(0,i))):[],[h.data,i]),p=!!h.data&&!h.error,y=!!(h.data&&0===x.length),f=!!(h.data&&h.size>h.data.length),j=!!(h.data&&h.data[h.data.length-1]?.aliases.length<=i);return[h,{aliases:x,initialDataLoaded:p,isEmpty:y,loadMore:()=>h.setSize(e=>e+1),isLoadingMore:f,isReachingEnd:j}]},"useAliasesV2",0,function(e,t){let{deploymentId:l,teamId:a}=e;return(0,i.useIsomorphicSWR)(l?function(e){let{deploymentId:t,teamId:l}=e;return`${(0,r.API_DEPLOYMENTS)("v2")}/${t}/aliases${(0,s.encode)({teamId:l})}`}({deploymentId:l,teamId:a}):null,t)}],5229375)},7018452,e=>{"use strict";var t=e.i(7185353);e.s(["default",0,function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",[l,a]=(0,t.useState)(!1),i=window.location.hash,s=e.startsWith("#")?e:`#${e}`;return(0,t.useEffect)(()=>{let e=()=>{window.location.hash!==s||l||a(!0)};return window.addEventListener("hashchange",e),()=>{window.removeEventListener("hashchange",e)}},[l,s]),i!==s||l||(a(!0),window.history.replaceState(null,""," ")),i!==s&&l&&(window.location.hash=s),[l,a]}])},9719784,e=>{"use strict";var t=e.i(847684),l=e.i(7185353),a=e.i(57106),i=e.i(822157),s=e.i(7018452),n=e.i(2405448),r=e.i(542164),o=e.i(1681029),c=e.i(4478191);let d=(0,l.memo)(function(e){let{url:d,truncate:u,defaultRoute:m,...h}=e,[x,p]=(0,s.default)("#wildcard"),[y,f]=(0,l.useState)(null),[j,g]=(0,l.useState)(!1),b=(0,l.useCallback)(()=>{f((0,n.default)(d)),p(!0)},[f,p,d]);return d?(0,r.default)(d)?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(a.Link,{className:"pt-px leading-[16px] hover:underline",onClick:b,...h,onMouseEnter:()=>g(!0),style:{minWidth:0,maxWidth:u?"100%":void 0},children:u?(0,t.jsx)("span",{className:"geist-ellipsis",children:d}):d}),j||x?(0,t.jsx)(i.default,{active:x,onCancel:()=>{p(!1)},url:y}):null]}):(0,t.jsx)(a.Link,{className:"pt-px leading-[16px] hover:underline",external:!0,href:(0,c.withDefaultRoute)((0,o.domainToUrl)(d),m),...h,style:{minWidth:0,maxWidth:u?"100%":void 0},children:u?(0,t.jsx)("span",{className:"geist-ellipsis",children:d}):d}):null});e.s(["default",0,d])},9365163,4904548,e=>{"use strict";var t=e.i(847684),l=e.i(7185353),a=e.i(5338940),i=e.i(1717203),s=e.i(7557283),n=e.i(4670733),r=e.i(588428),o=e.i(4396019),c=e.i(762945),d=e.i(7749291),u=e.i(8735244),m=e.i(2504781),h=e.i(6891161),x=e.i(455575),p=e.i(8522580),y=e.i(8761240),f=e.i(5756088),j=e.i(9386557),g=e.i(4004502),b=e.i(8042625),v=e.i(277234),k=e.i(4244280),S=e.i(5140444),C=e.i(5757634),A=e.i(5802506),R=e.i(6641571);e.i(9623499);var N=e.i(5576066),D=e.i(3924999),w=e.i(5229375);e.i(2598434);var P=e.i(9668517);let T="[teamSlug]";var I=e.i(6060673),M=e.i(930810),E=e.i(7952834),L=e.i(1173672),O=e.i(8227242),B=e.i(9745887),$=e.i(3306538),_=e.i(5468328),F=e.i(9719784);function H(e){let{hidden:l,showIcon:a=!0,linkProps:i,defaultRoute:s}=e;return(0,t.jsx)(t.Fragment,{children:l.map(e=>(0,t.jsx)("div",{children:(0,t.jsx)(F.default,{defaultRoute:s,icon:a,title:e,truncate:!0,url:e,...i})},e))})}function W(e){let{hidden:l,linkProps:a}=e;return(0,t.jsx)(_.Tooltip,{text:(0,t.jsx)(H,{hidden:l,linkProps:a}),children:(0,t.jsx)($.Badge,{size:"sm",variant:"gray-subtle",children:`+${l.length}`})})}let q=function(e){let{className:l,defaultRoute:a,domains:i,firstOnly:s,showIcon:n=!0,style:r,linkProps:o}=e;if(!i)return(0,t.jsx)("span",{className:`text-copy-14 text-gray-900 ${l}`,style:r,children:"-"});let{visible:c,hidden:d}=i.reduce((e,t)=>(0===e.visible.length||!s&&1===e.visible.length&&e.visible[0].length<=20?e.visible.push(t):e.hidden.push(t),e),{visible:[],hidden:[]});return(0,t.jsx)("span",{className:`text-[14px] leading-[20px] font-medium ${l}`,children:(0,t.jsxs)("div",{className:"flex flex-row items-stretch justify-start gap-2 flex-initial max-w-full",style:{...r},children:[c.map((e,l)=>{let i=l===c.length-1;return(0,t.jsx)(F.default,{defaultRoute:a,icon:n,style:{marginRight:i?void 0:"var(--geist-gap-half)",minWidth:0},truncate:!0,url:e,...o},e)}),d.length?(0,t.jsx)(W,{hidden:d,linkProps:o}):null]})})};e.s(["default",0,q],4904548);var z=e.i(8651268),U=e.i(2547843);function V(){return(0,t.jsx)(h.Modal.Header,{children:(0,t.jsx)(h.Modal.Title,{center:!0,children:"Instant Rollback"})})}function Y(e){let{setStage:l}=e;return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(h.Modal.Body,{children:[(0,t.jsx)(V,{}),(0,t.jsx)("p",{className:"text-copy-14",style:{marginBottom:"24px"},children:"Error: You must select a deployment to roll back."})]}),(0,t.jsx)(h.Modal.Actions,{children:(0,t.jsx)(h.Modal.Action,{fullWidth:!0,onClick:()=>{l("initial")},type:"secondary",children:"Back"})})]})}function K(){return(0,t.jsx)("div",{children:(0,t.jsx)(p.Note,{className:"bg-yellow-50 border-yellow-300 border text-amber-700",fill:!0,label:!1,type:"warning",variant:"contrast",children:(0,t.jsxs)("div",{className:"flex flex-row items-center justify-start gap-4 flex-initial",style:{padding:4},children:[(0,t.jsx)(c.Warning,{style:{flexShrink:0}}),(0,t.jsxs)("div",{className:"flex flex-col items-start justify-start flex-initial",children:[(0,t.jsx)("p",{className:"text-copy-14 text-inherit",children:"Make sure the domains listed above are correct."}),(0,t.jsx)("p",{className:"text-copy-14 text-inherit",children:"This deployment has custom aliases not included in the project's domain settings."})]})]})})})}function J(e){var i;let s,{hasFloatingAliases:o,onCancel:c,previousDeployment:d,productionAliases:u,productionDeployment:x,project:y,rollbackCandidates:j,setStage:b,selectedDeployment:v,setSelectedDeployment:k,deploymentSwr:S,rollbackReason:C,setRollbackReason:A}=e,R=(i="/[teamSlug]",s=(0,P.useTeamSlug)(),(0,l.useMemo)(()=>i.includes(T)?i.replace(`/${T}`,s?`/${s}`:""):i,[s,i])),[D,w]=(0,l.useState)(!1),{team:I}=(0,a.useTeam)(),E=!I||I.billing?.plan==="hobby",{value:L}=(0,n.useInstantRollbackHobbyRestrictionFlag)(),{value:O}=(0,r.useInstantRollbackHobbyRestrictionTeamFlag)();return j.length&&d&&v?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(h.Modal.Body,{children:[(0,t.jsx)(V,{}),(0,t.jsxs)("div",{className:"flex flex-col items-stretch justify-start gap-4 flex-initial",children:[(0,t.jsxs)("div",{className:"flex flex-col items-stretch justify-start gap-2 flex-initial",children:[(0,t.jsxs)("p",{className:"text-copy-16",children:["Rolling back"," ",(0,t.jsx)(q,{domains:u,firstOnly:!0,style:{display:"inline-flex",fontWeight:"500"}})]}),o?(0,t.jsx)(K,{}):null,(0,t.jsx)("div",{children:(0,t.jsx)(B.DeploymentCardSmall,{deployment:x,isProductionDeployment:!0,selectedDeployment:v,setSelectedDeployment:k})})]}),(0,t.jsxs)("div",{className:"flex flex-col items-stretch justify-start gap-2 flex-initial",children:[(0,t.jsx)("p",{className:"text-copy-16",children:"To the following deployment:"}),D?(0,t.jsx)("div",{children:(0,t.jsx)(M.ChooseDeploymentList,{deployments:j,previousDeployment:d,productionDeployment:x,rolledBackDeploymentId:y?.lastAliasRequest?.type==="rollback"?y.lastAliasRequest.fromDeploymentId:void 0,selectedDeployment:v,setSelectedDeployment:k,swr:S})}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{children:(0,t.jsx)(B.DeploymentCardSmall,{deployment:v,isForm:D,isPreviousDeployment:v.uid===d.uid,selectedDeployment:v,setSelectedDeployment:k})}),(L||O)&&E?(0,t.jsx)("div",{className:"flex flex-col items-stretch justify-start flex-initial mt-6",children:(0,t.jsx)(p.Note,{className:"bg-blue-50 border border-blue-500 text-blue-600",fill:!0,label:!1,size:"small",variant:"contrast",children:(0,t.jsxs)("div",{className:"flex flex-row items-center justify-start gap-4 flex-initial p-2",children:[(0,t.jsx)(f.LockClosed,{style:{transform:"translateX(1px)"}}),(0,t.jsxs)("div",{className:"flex flex-col items-start justify-start flex-initial",children:[(0,t.jsx)("p",{className:"text-[14px] leading-[20px] font-medium text-inherit",children:"Looking for an earlier deployment?"}),(0,t.jsxs)("div",{children:[(0,t.jsx)(N.Link,{className:"text-current no-underline",external:!0,href:"/"===R?"/dashboard?createTeam=instant-rollback":`${R}?upgradeTeam=instant-rollback`,target:"_blank",children:(0,t.jsx)("span",{className:"text-copy-14 text-inherit",children:"Upgrade to Pro"})}),(0,t.jsxs)("span",{className:"text-copy-14 text-inherit",style:{whiteSpace:"nowrap"},children:[" ","to roll back to an earlier deployment"]})]})]})]})})}):(0,t.jsx)(m.Button,{onClick:()=>{w(!0)},type:"secondary",width:"100%",size:"small",children:"Choose another deployment"})]})]}),(0,t.jsxs)("div",{className:"flex flex-col items-stretch justify-start gap-2 flex-initial",children:[(0,t.jsx)("label",{htmlFor:"rollback-reason",className:"flex flex-col items-stretch justify-start gap-1 flex-initial",children:(0,t.jsx)("span",{className:"text-copy-16",children:"Share a reason for this rollback:"})}),(0,t.jsx)(M.RollbackDescriptionTextarea,{value:C,onChange:A,id:"rollback-reason"})]})]})]}),(0,t.jsxs)(h.Modal.Actions,{children:[(0,t.jsx)(h.Modal.Action,{onClick:c,type:"secondary",children:"Cancel"}),(0,t.jsx)(h.Modal.Action,{"data-testid":(0,g.tid)("deployment","rollback-modal","continue-button"),disabled:C.length>=M.REASON_MAX_CHARACTER_LENGTH,onClick:()=>{b("selected")},children:"Continue"})]})]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(h.Modal.Body,{children:[(0,t.jsx)(V,{}),(0,t.jsx)("p",{className:"text-copy-14",children:"This project does not have any valid deployments to roll back to."})]}),(0,t.jsx)(h.Modal.Actions,{children:(0,t.jsx)(h.Modal.Action,{onClick:c,type:"secondary",children:"Cancel"})})]})}function X(e){let{selectedDeployment:l,setStage:a,requestRollback:i,project:s,rollbackReason:n,rollbackCandidates:r}=e,{user:o}=(0,S.useUser)();if(!l)return(0,t.jsx)(Y,{setStage:a});let c=n.length>=M.REASON_MAX_CHARACTER_LENGTH,u=(0,M.getMostRecentlyPromotedDeployment)(r);return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(h.Modal.Body,{children:[(0,t.jsx)(V,{}),(0,t.jsxs)("div",{className:"flex flex-col items-stretch justify-start gap-2 flex-initial",children:[(0,t.jsxs)("div",{className:"flex flex-col items-stretch justify-start gap-2 flex-initial",children:[(0,t.jsx)("p",{className:"text-copy-16",children:"Rolling back to:"}),(0,t.jsx)(B.DeploymentCardSmall,{deployment:l,isPreviousDeployment:l.uid===u?.uid,selectedDeployment:l,setSelectedDeployment:()=>null})]}),n.trim()&&(0,t.jsx)("div",{className:"flex flex-col items-stretch justify-start gap-4 flex-initial",children:(0,t.jsx)(M.RollbackDescriptionCard,{rollbackDescription:{description:n.trim(),userId:o?.uid??"",username:o?.username??"",deploymentId:l.uid,projectId:s?.id??"",createdAt:new Date().getTime()},project:s,preview:!0})}),(0,t.jsxs)(R.UL,{className:"mb-0",children:[(0,t.jsx)(R.LI,{children:"Instant Rollback assigns domains to a previous deployment. All Environment Variables from the original build will remain. Cron jobs will be reverted to the state of the previous deployment."}),(0,t.jsxs)(R.LI,{children:[(0,t.jsxs)(N.Link,{className:"inline-flex items-center text-[var(--geist-success)] no-underline",href:`https://${l.url}`,target:"_blank",children:["View the selected deployment ",(0,t.jsx)(d.ExternalSmall,{className:"ml-1"})]})," ","before rolling back—external APIs, databases, and CMS platforms may not behave as expected."]}),(0,t.jsx)(R.LI,{children:"You can update the rollback reason from the project overview."})]}),(s?.autoAssignCustomDomains??!0)||s?.lastAliasRequest?.type==="rollback"?(0,t.jsx)(p.Note,{fill:!0,type:"secondary",children:(0,t.jsx)("div",{className:"flex flex-row items-center justify-start gap-4 flex-initial",children:(0,t.jsx)("div",{className:"flex flex-col items-start justify-start flex-initial",children:(0,t.jsx)("p",{className:"text-copy-14 text-inherit",children:"After rolling back, production deployments will not be automatically promoted until the rollback is removed."})})})}):null]})]}),(0,t.jsxs)(h.Modal.Actions,{children:[(0,t.jsx)(h.Modal.Action,{onClick:()=>{a("initial")},type:"secondary",children:"Back"}),(0,t.jsx)(h.Modal.Action,{"data-testid":(0,g.tid)("deployment","rollback-modal","rollback-button"),disabled:c,onClick:()=>{i(l.uid),a("processing")},children:"Confirm Rollback"})]})]})}function G(e){let{jobStatus:a,rollbackDeploymentId:i,rollbackCandidates:s,selectedDeployment:n,setStage:r,onCancel:o,statusSwr:c,requestRollback:d,rollbackReason:x}=e,{user:p}=(0,S.useUser)();if((0,l.useEffect)(()=>{i===n?.uid&&("failed"===a?r("error"):"succeeded"===a&&r("done"))},[i,a,n,r]),!n)return(0,t.jsx)(Y,{setStage:r});let f=(0,M.getMostRecentlyPromotedDeployment)(s);return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(h.Modal.Body,{children:[(0,t.jsx)(V,{}),(0,t.jsxs)("div",{className:"flex flex-col items-stretch justify-start gap-2 flex-initial",children:[(0,t.jsxs)("div",{className:"flex flex-col items-stretch justify-start gap-2 flex-initial",children:[(0,t.jsx)("p",{className:"text-copy-14",children:"Assigning production domains:"}),(0,t.jsx)(B.DeploymentCardSmall,{deployment:n,isPreviousDeployment:n.uid===f?.uid,selectedDeployment:n,setSelectedDeployment:()=>null})]}),""!==x?(0,t.jsxs)("div",{className:"rounded bg-background-200 px-4 py-3 shadow-border",children:[(0,t.jsxs)("p",{className:"text-copy-14 text-gray-900",children:["“",(0,t.jsx)(O.LinkParser,{text:x.trim()}),"”"]}),(0,t.jsxs)("div",{className:"flex gap-1 pt-1",children:[(0,t.jsx)("p",{className:"text-copy-14",children:"Rolled back by"}),p?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(z.PrincipalAvatar,{size:20,principalId:p.uid,principal:{type:"user",uid:p.uid,username:p.username}}),(0,t.jsx)("p",{className:"text-copy-14",children:p.username})]}):null]})]}):null,(0,t.jsxs)(R.UL,{className:"mx-4 my-0 list-none pt-2",children:[c.aliases.map(e=>{let l="loading";return"completed"===e.status?l="success":"failed"===e.status&&(l="error"),(0,t.jsx)(R.LI,{children:(0,t.jsxs)("div",{className:"h-6 flex items-center gap-2",children:["loading"===l&&(0,t.jsx)(u.Spinner,{className:"shrink-0",size:16}),"error"===l&&(0,t.jsx)(j.WarningFill,{className:"shrink-0",color:"amber-800",size:16}),"success"===l&&(0,t.jsx)(y.CheckCircleFill,{className:"shrink-0",color:"blue-700",size:16}),(0,t.jsx)("span",{className:"text-copy-14 truncate",children:e.alias})]})},e.alias)}),!c.isReachingEnd&&c.initialDataLoaded?(0,t.jsx)(R.LI,{children:(0,t.jsx)(m.Button,{loading:c.isLoadingMore,onClick:()=>{c.loadMore()},style:{marginTop:24},type:"secondary",width:"100%",children:"Show More"})}):null]})]})]}),(0,t.jsx)(h.Modal.Actions,{children:(0,t.jsx)(h.Modal.Action,{"data-testid":(0,g.tid)("deployment","rollback-modal","finish-button"),fullWidth:!0,loading:"failed"!==a&&"succeeded"!==a,onClick:()=>{"failed"===a?d(n.uid):"succeeded"===a&&(r("initial"),o())},children:"failed"===a?"Retry":"Done"})})]})}function Q(e){let{active:i,initialSelectedDeployment:s,onCancel:n,productionBranch:r,productionDeployment:o,projectId:c,rollbackCandidates:d,swr:u,rollbackDescription:m}=e,{mutate:p}=(0,C.useSWRConfig)(),[y,f]=(0,l.useState)("initial"),[j,S]=(0,l.useState)(""),{isReady:R,team:N}=(0,a.useTeam)(),P=(0,x.useToasts)(),T=(0,l.useMemo)(()=>{let e=d.filter(e=>e.uid!==o.id);return(0,M.getMostRecentlyPromotedDeployment)(e)},[d,o]),[O,B]=(0,l.useState)(null),$=O??s??T??null,_=(0,l.useCallback)(f,[f]),F=(0,l.useCallback)(B,[B]),[,{aliases:H}]=(0,w.useAliasesInfinite)({rollbackDeploymentId:o.id}),{data:W}=(0,I.useProject)(c),{lastAliasRequest:q,hasFloatingAliases:z}=W||{lastAliasRequest:void 0,hasFloatingAliases:!1},{toDeploymentId:V,jobStatus:Y}=q||{toDeploymentId:null,jobStatus:null},[,K]=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:20,{isReady:s,team:n}=(0,a.useTeam)(),r=(0,D.default)((t,l)=>{if(!s)return null;let a={teamId:n?.id,limit:i};return t?l?.next?`${(0,k.API_PROJECTS_ROLLBACK_ALIAS_STATUS)(e)}${(0,b.encode)({...a,until:l.next})}`:null:`${(0,k.API_PROJECTS_ROLLBACK_ALIAS_STATUS)(e)}${(0,b.encode)(a)}`},e=>(0,v.fetchAPI)(e,{throwOnHTTPError:!0}),{refreshInterval:t}),o=(0,l.useMemo)(()=>r.data?[].concat(...r.data.filter(Boolean).map(e=>e.aliases.slice(0,i))):[],[r.data,i]),c=!!r.data,d=c&&0===o.length,u=c&&r.data&&r.size>r.data.length,m=c&&r.data&&r.data[r.data.length-1]?.aliases.length<i;return[r,{aliases:o,initialDataLoaded:c,isEmpty:d,loadMore:()=>r.setSize(e=>e+1),isLoadingMore:u,isReachingEnd:m,mutate:r.mutate}]}(c,2e3),Q=(0,l.useMemo)(()=>o,[i]),Z=()=>{f("initial"),B(s||T||null),n()},ee=(0,l.useCallback)(async e=>{if(!R)return;let t=`${(0,k.API_DEPLOYMENT_ROLLBACK)(c,e)}${(0,b.encode)({teamId:N?.id,description:j.trim()})}`;try{await (0,v.fetchAPI)(t,{throwOnHTTPError:!0,method:"POST",body:{}}),N&&(void 0!==W&&(0,E.revalidateProject)(p,W),await p((0,L.getProjectProductionDeploymentKey)({projectIdOrName:c,teamId:N.slug})),p((0,U.getRollingReleaseEndpoint)(N.slug,c)))}catch(e){P.error({text:"Something went wrong - please try requesting an Instant Rollback again",key:"rollback-deployment"}),(0,A.captureError)(e)}},[R,c,P,j,p,N,W]),et={rollbackDeploymentId:V,hasFloatingAliases:!!z,jobStatus:Y,onCancel:Z,previousDeployment:T,productionBranch:r,productionDeployment:Q,productionAliases:H.map(e=>{let{alias:t}=e;return t}),project:W,rollbackCandidates:d,setStage:_,selectedDeployment:$,setSelectedDeployment:F,deploymentSwr:u,statusSwr:K,requestRollback:ee,rollbackWarningText:"New deployments will not be automatically assigned production domains until this rollback is removed.",rollbackReason:j,setRollbackReason:S,rollbackDescription:m};return(0,t.jsxs)(h.Modal.Modal,{active:i,"data-testid":(0,g.tid)("deployment","rollback-modal"),onClickOutside:Z,sticky:!0,width:"500px",children:["initial"===y&&(0,t.jsx)(J,{...et}),"selected"===y&&(0,t.jsx)(X,{...et}),["processing","error","done"].includes(y)&&(0,t.jsx)(G,{...et})]})}var Z=e.i(5771992),ee=e.i(5645345),et=e.i(3981247);e.i(3182268);var el=e.i(7849855);e.s(["useInstantRollbackModal",0,function(e){let{onClose:a}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},[n,r]=(0,l.useState)(!1),[c,d]=(0,l.useState)(),{teamSlug:u,projectSlug:m}=(0,el.useProjectAndTeamSlug)(),{data:h}=(0,I.useProject)(c?.name),x=m??c?.name,p=e??h,{data:y}=(0,et.useRollingRelease)({teamIdOrSlug:u,projectSlug:x}),f=y?.rollingRelease?y?.rollingRelease?.canaryDeployment?.id:void 0,{deployment:j,rollbackDescription:g,mutate:b}=(0,o.useProjectProductionDeployment)(p?.name),{can:v}=(0,i.default)({projectIdOrName:p?.name}),k=v(s.Action.Create,s.Resource.DeploymentRollback),S=p?.link?.productionBranch?p.link.productionBranch:void 0,[C,A]=(0,Z.useDeploymentsInfinite)({projectId:p?p.id:"",requireProject:!0,limit:10,rollbackCandidate:!0},{}),{deployments:R,initialDataLoaded:N}=A,D=R.filter(e=>!!e.isRollbackCandidate&&e.uid!==f),w=!!(N&&p&&!D.length),P=(0,l.useCallback)(e=>{d((0,ee.asListDeployment)(e)),r(!0)},[]),T=(0,l.useCallback)(()=>{r(!1),b().finally(()=>null),a?.()},[b,a]);return{rollbackModal:(0,l.useMemo)(()=>k&&n&&j&&p?(0,t.jsx)(Q,{active:n,initialSelectedDeployment:c,onCancel:T,productionBranch:S,productionDeployment:j,projectId:p.id,rollbackCandidates:D,rollbackDescription:g,swr:A}):null,[k,n,c,S,j,D,p,A,T,g]),closeRollbackModal:T,openRollbackModal:P,canRollbackDeployment:k,noRollbackCandidates:w}},"useRollbackTooltip",0,function(e){let{team:t}=(0,a.useTeam)(),i=!t||t.billing?.plan==="hobby",{value:s}=(0,n.useInstantRollbackHobbyRestrictionFlag)(),{value:c}=(0,r.useInstantRollbackHobbyRestrictionTeamFlag)(),d=s||c,u=e?.name,{deployment:m,isLoading:h}=(0,o.useProjectProductionDeployment)(u);return(0,l.useMemo)(()=>{let t=(0,ee.asListDeployment)(e),l=i&&!t?.isRollbackCandidate;return t?h?"Loading…":"readyState"in t&&"READY"!==t.readyState?"Only Deployments that are Ready can be rolled back.":"readySubstate"in t&&"PROMOTED"!==t.readySubstate?"Only Deployments previously aliased to a Production domain can be rolled back.":t.uid===m?.id?"This Deployment is already in Production.":d?t.isRollbackCandidate||"production"===t.target?l?"Hobby customers can only roll back to the previous deployment.":"":"Only Deployments previously aliased to a Production domain can be rolled back.":t.isRollbackCandidate?"":"Only Deployments previously aliased to a Production domain can be rolled back.":""},[e,i,h,m?.id,d])}],9365163)}]);

//# debugId=d74356a4-c89d-bf46-ff81-d885338c97a9
//# sourceMappingURL=8976be38618da9fc.js.map